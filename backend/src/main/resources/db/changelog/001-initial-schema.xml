<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
    http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">

  <changeSet id="001-create-tournaments" author="padelscore">
    <createTable tableName="tournaments">
      <column name="id" type="SERIAL">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="title" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="description" type="TEXT"/>
      <column name="created_by_player_profile_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="start_date" type="TIMESTAMP"/>
      <column name="end_date" type="TIMESTAMP"/>
      <column name="format" type="VARCHAR(50)"/>
      <column name="scoring_system" type="VARCHAR(50)"/>
      <column name="prize" type="TEXT"/>
      <column name="status" type="VARCHAR(50)"/>
      <column name="completed" type="BOOLEAN" defaultValueBoolean="false">
        <constraints nullable="false"/>
      </column>
      <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
        <constraints nullable="false"/>
      </column>
      <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
    </createTable>
  </changeSet>

  <changeSet id="002-create-teams" author="padelscore">
    <createTable tableName="teams">
      <column name="id" type="SERIAL">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="tournament_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="captain_player_profile_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="description" type="TEXT"/>
      <column name="color" type="VARCHAR(7)"/>
      <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
        <constraints nullable="false"/>
      </column>
      <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
    </createTable>
    <addForeignKeyConstraint
      baseTableName="teams"
      baseColumnNames="tournament_id"
      referencedTableName="tournaments"
      referencedColumnNames="id"
      constraintName="fk_teams_tournament"
      onDelete="CASCADE"/>
    <addUniqueConstraint
      tableName="teams"
      columnNames="tournament_id, name"
      constraintName="uk_teams_tournament_name"/>
  </changeSet>

  <changeSet id="003-create-player-profiles" author="padelscore">
    <createTable tableName="player_profiles">
      <column name="id" type="SERIAL">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="first_name" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="last_name" type="VARCHAR(255)"/>
      <column name="telegram_id" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="nickname" type="VARCHAR(255)">
        <constraints nullable="false"/>
      </column>
      <column name="rating" type="INTEGER"/>
      <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
        <constraints nullable="false"/>
      </column>
      <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
    </createTable>
    <addUniqueConstraint
      tableName="player_profiles"
      columnNames="telegram_id"
      constraintName="uk_player_profiles_telegram_id"/>
    <addUniqueConstraint
      tableName="player_profiles"
      columnNames="nickname"
      constraintName="uk_player_profiles_nickname"/>
  </changeSet>

  <changeSet id="003-1-add-fk-to-player-profiles" author="padelscore">
    <addForeignKeyConstraint
      baseTableName="tournaments"
      baseColumnNames="created_by_player_profile_id"
      referencedTableName="player_profiles"
      referencedColumnNames="id"
      constraintName="fk_tournaments_created_by"
      onDelete="RESTRICT"/>
    <addForeignKeyConstraint
      baseTableName="teams"
      baseColumnNames="captain_player_profile_id"
      referencedTableName="player_profiles"
      referencedColumnNames="id"
      constraintName="fk_teams_captain_player_profile"
      onDelete="RESTRICT"/>
  </changeSet>

  <changeSet id="004-create-team-players" author="padelscore">
    <createTable tableName="team_players">
      <column name="id" type="SERIAL">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="team_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="player_profile_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="position" type="VARCHAR(50)"/>
      <column name="joined_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint
      baseTableName="team_players"
      baseColumnNames="team_id"
      referencedTableName="teams"
      referencedColumnNames="id"
      constraintName="fk_team_players_team"
      onDelete="CASCADE"/>
    <addForeignKeyConstraint
      baseTableName="team_players"
      baseColumnNames="player_profile_id"
      referencedTableName="player_profiles"
      referencedColumnNames="id"
      constraintName="fk_team_players_player_profile"
      onDelete="CASCADE"/>
    <addUniqueConstraint
      tableName="team_players"
      columnNames="team_id, player_profile_id"
      constraintName="uk_team_players_team_player"/>
    <createIndex
      indexName="idx_team_players_team_id"
      tableName="team_players">
      <column name="team_id"/>
    </createIndex>
    <createIndex
      indexName="idx_team_players_player_profile_id"
      tableName="team_players">
      <column name="player_profile_id"/>
    </createIndex>
  </changeSet>

  <changeSet id="005-create-matches" author="padelscore">
    <createTable tableName="matches">
      <column name="id" type="SERIAL">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="tournament_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="team1_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="team2_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="scheduled_date" type="TIMESTAMP"/>
      <column name="status" type="VARCHAR(50)"/>
      <column name="format" type="VARCHAR(50)"/>
      <column name="location" type="VARCHAR(255)"/>
      <column name="completed" type="BOOLEAN" defaultValueBoolean="false">
        <constraints nullable="false"/>
      </column>
      <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
        <constraints nullable="false"/>
      </column>
      <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
    </createTable>
    <addForeignKeyConstraint
      baseTableName="matches"
      baseColumnNames="tournament_id"
      referencedTableName="tournaments"
      referencedColumnNames="id"
      constraintName="fk_matches_tournament"
      onDelete="CASCADE"/>
    <addForeignKeyConstraint
      baseTableName="matches"
      baseColumnNames="team1_id"
      referencedTableName="teams"
      referencedColumnNames="id"
      constraintName="fk_matches_team1"/>
    <addForeignKeyConstraint
      baseTableName="matches"
      baseColumnNames="team2_id"
      referencedTableName="teams"
      referencedColumnNames="id"
      constraintName="fk_matches_team2"/>
    <sql>
      ALTER TABLE matches
        ADD CONSTRAINT check_teams CHECK (team1_id != team2_id);
    </sql>
  </changeSet>

  <changeSet id="006-create-match-results" author="padelscore">
    <createTable tableName="match_results">
      <column name="id" type="SERIAL">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="match_id" type="INTEGER">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="winner_team_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="loser_team_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="winner_points" type="INTEGER" defaultValue="3"/>
      <column name="loser_points" type="INTEGER" defaultValue="1"/>
      <column name="final_score" type="VARCHAR(50)"/>
      <column name="notes" type="TEXT"/>
      <column name="submitted_by_player_profile_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="submitted_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
      <column name="disputed" type="BOOLEAN" defaultValueBoolean="false">
        <constraints nullable="false"/>
      </column>
      <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
        <constraints nullable="false"/>
      </column>
      <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
    </createTable>
    <addForeignKeyConstraint
      baseTableName="match_results"
      baseColumnNames="match_id"
      referencedTableName="matches"
      referencedColumnNames="id"
      constraintName="fk_match_results_match"
      onDelete="CASCADE"/>
    <addForeignKeyConstraint
      baseTableName="match_results"
      baseColumnNames="winner_team_id"
      referencedTableName="teams"
      referencedColumnNames="id"
      constraintName="fk_match_results_winner"/>
    <addForeignKeyConstraint
      baseTableName="match_results"
      baseColumnNames="loser_team_id"
      referencedTableName="teams"
      referencedColumnNames="id"
      constraintName="fk_match_results_loser"/>
  </changeSet>

  <changeSet id="007-create-set-scores" author="padelscore">
    <createTable tableName="set_scores">
      <column name="id" type="SERIAL">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="match_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="set_number" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="team1_games" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="team2_games" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="tiebreaker_team1" type="INTEGER"/>
      <column name="tiebreaker_team2" type="INTEGER"/>
      <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
        <constraints nullable="false"/>
      </column>
      <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
    </createTable>
    <addForeignKeyConstraint
      baseTableName="set_scores"
      baseColumnNames="match_id"
      referencedTableName="matches"
      referencedColumnNames="id"
      constraintName="fk_set_scores_match"
      onDelete="CASCADE"/>
    <addUniqueConstraint
      tableName="set_scores"
      columnNames="match_id, set_number"
      constraintName="uk_set_scores_match_set"/>
  </changeSet>

  <changeSet id="008-create-game-scores" author="padelscore">
    <createTable tableName="game_scores">
      <column name="id" type="SERIAL">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="set_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="game_number" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="server_team_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="team1_points" type="INTEGER" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="team2_points" type="INTEGER" defaultValue="0">
        <constraints nullable="false"/>
      </column>
      <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
        <constraints nullable="false"/>
      </column>
      <column name="updated_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP"/>
    </createTable>
    <addForeignKeyConstraint
      baseTableName="game_scores"
      baseColumnNames="set_id"
      referencedTableName="set_scores"
      referencedColumnNames="id"
      constraintName="fk_game_scores_set"
      onDelete="CASCADE"/>
    <addForeignKeyConstraint
      baseTableName="game_scores"
      baseColumnNames="server_team_id"
      referencedTableName="teams"
      referencedColumnNames="id"
      constraintName="fk_game_scores_server"/>
    <addUniqueConstraint
      tableName="game_scores"
      columnNames="set_id, game_number"
      constraintName="uk_game_scores_set_game"/>
  </changeSet>

  <changeSet id="009-create-user-roles" author="padelscore">
    <createTable tableName="user_roles">
      <column name="id" type="SERIAL">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="tournament_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="player_profile_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="role" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <addForeignKeyConstraint
      baseTableName="user_roles"
      baseColumnNames="tournament_id"
      referencedTableName="tournaments"
      referencedColumnNames="id"
      constraintName="fk_user_roles_tournament"
      onDelete="CASCADE"/>
    <addUniqueConstraint
      tableName="user_roles"
      columnNames="tournament_id, player_profile_id"
      constraintName="uk_user_roles_tournament_player"/>
  </changeSet>

  <changeSet id="010-create-audit-logs" author="padelscore">
    <createTable tableName="audit_logs">
      <column name="id" type="SERIAL">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="entity_type" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="entity_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="action" type="VARCHAR(50)">
        <constraints nullable="false"/>
      </column>
      <column name="player_profile_id" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="old_values" type="jsonb"/>
      <column name="new_values" type="jsonb"/>
      <column name="created_at" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
        <constraints nullable="false"/>
      </column>
    </createTable>
    <createIndex
      indexName="idx_audit_logs_entity"
      tableName="audit_logs">
      <column name="entity_type"/>
      <column name="entity_id"/>
    </createIndex>
    <createIndex
      indexName="idx_audit_logs_created_at"
      tableName="audit_logs">
      <column name="created_at"/>
    </createIndex>
  </changeSet>

  <changeSet id="010-1-add-fk-player-profiles-remaining" author="padelscore">
    <addForeignKeyConstraint
      baseTableName="match_results"
      baseColumnNames="submitted_by_player_profile_id"
      referencedTableName="player_profiles"
      referencedColumnNames="id"
      constraintName="fk_match_results_submitted_by"
      onDelete="RESTRICT"/>
    <addForeignKeyConstraint
      baseTableName="user_roles"
      baseColumnNames="player_profile_id"
      referencedTableName="player_profiles"
      referencedColumnNames="id"
      constraintName="fk_user_roles_player_profile"
      onDelete="CASCADE"/>
    <addForeignKeyConstraint
      baseTableName="audit_logs"
      baseColumnNames="player_profile_id"
      referencedTableName="player_profiles"
      referencedColumnNames="id"
      constraintName="fk_audit_logs_player_profile"
      onDelete="RESTRICT"/>
  </changeSet>

</databaseChangeLog>
