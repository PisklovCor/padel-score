<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
  xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
  xsi:schemaLocation="
          http://www.liquibase.org/xml/ns/dbchangelog
          http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.24.xsd">

  <!-- 1. Общая функция аудита -->
  <changeSet id="audit-fn" author="padelscore">
    <sql splitStatements="false">
      CREATE OR REPLACE FUNCTION audit_log_changes()
            RETURNS TRIGGER AS $$
            DECLARE
      v_entity_id          integer;
      v_player_profile_id  integer;
      BEGIN
              -- читаем app.player_profile_id из сессии/транзакции
      BEGIN
                v_player_profile_id := current_setting('app.player_profile_id')::integer;
      EXCEPTION WHEN others THEN
                -- если переменная не установлена (DDL / ручной SQL) — пишем -1
                v_player_profile_id := -1;
      END;

      IF TG_OP = 'INSERT' THEN
                v_entity_id := NEW.id;
      INSERT INTO audit_logs (entity_type, entity_id, action, player_profile_id, old_values, new_values)
      VALUES (TG_TABLE_NAME, v_entity_id, 'INSERT', v_player_profile_id, NULL, to_jsonb(NEW));

      ELSIF TG_OP = 'UPDATE' THEN
                v_entity_id := NEW.id;
      INSERT INTO audit_logs (entity_type, entity_id, action, player_profile_id, old_values, new_values)
      VALUES (TG_TABLE_NAME, v_entity_id, 'UPDATE', v_player_profile_id, to_jsonb(OLD), to_jsonb(NEW));

      ELSIF TG_OP = 'DELETE' THEN
                v_entity_id := OLD.id;
      INSERT INTO audit_logs (entity_type, entity_id, action, player_profile_id, old_values, new_values)
      VALUES (TG_TABLE_NAME, v_entity_id, 'DELETE', v_player_profile_id, to_jsonb(OLD), NULL);
      END IF;

              IF TG_OP = 'DELETE' THEN
                RETURN OLD;
      ELSE
                RETURN NEW;
      END IF;
      END;
            $$ LANGUAGE plpgsql;
    </sql>

    <rollback>
      DROP FUNCTION IF EXISTS audit_log_changes();
    </rollback>
  </changeSet>

  <!-- 2. Триггеры на бизнес‑таблицы -->

  <!-- tournaments -->
  <changeSet id="audit-trigger-tournaments" author="padelscore">
    <sql>
      CREATE TRIGGER trg_audit_tournaments
        AFTER INSERT OR UPDATE OR DELETE ON tournaments
        FOR EACH ROW
        EXECUTE FUNCTION audit_log_changes();
    </sql>
    <rollback>
      DROP TRIGGER IF EXISTS trg_audit_tournaments ON tournaments;
    </rollback>
  </changeSet>

  <!-- teams -->
  <changeSet id="audit-trigger-teams" author="padelscore">
    <sql>
      CREATE TRIGGER trg_audit_teams
        AFTER INSERT OR UPDATE OR DELETE ON teams
        FOR EACH ROW
        EXECUTE FUNCTION audit_log_changes();
    </sql>
    <rollback>
      DROP TRIGGER IF EXISTS trg_audit_teams ON teams;
    </rollback>
  </changeSet>

  <!-- player_profiles -->
  <changeSet id="audit-trigger-player-profiles" author="padelscore">
    <sql>
      CREATE TRIGGER trg_audit_player_profiles
        AFTER INSERT OR UPDATE OR DELETE ON player_profiles
        FOR EACH ROW
        EXECUTE FUNCTION audit_log_changes();
    </sql>
    <rollback>
      DROP TRIGGER IF EXISTS trg_audit_player_profiles ON player_profiles;
    </rollback>
  </changeSet>

  <!-- team_players -->
  <changeSet id="audit-trigger-team-players" author="padelscore">
    <sql>
      CREATE TRIGGER trg_audit_team_players
        AFTER INSERT OR UPDATE OR DELETE ON team_players
        FOR EACH ROW
        EXECUTE FUNCTION audit_log_changes();
    </sql>
    <rollback>
      DROP TRIGGER IF EXISTS trg_audit_team_players ON team_players;
    </rollback>
  </changeSet>

  <!-- matches -->
  <changeSet id="audit-trigger-matches" author="padelscore">
    <sql>
      CREATE TRIGGER trg_audit_matches
        AFTER INSERT OR UPDATE OR DELETE ON matches
        FOR EACH ROW
        EXECUTE FUNCTION audit_log_changes();
    </sql>
    <rollback>
      DROP TRIGGER IF EXISTS trg_audit_matches ON matches;
    </rollback>
  </changeSet>

  <!-- match_results -->
  <changeSet id="audit-trigger-match-results" author="padelscore">
    <sql>
      CREATE TRIGGER trg_audit_match_results
        AFTER INSERT OR UPDATE OR DELETE ON match_results
        FOR EACH ROW
        EXECUTE FUNCTION audit_log_changes();
    </sql>
    <rollback>
      DROP TRIGGER IF EXISTS trg_audit_match_results ON match_results;
    </rollback>
  </changeSet>

  <!-- set_scores -->
  <changeSet id="audit-trigger-set-scores" author="padelscore">
    <sql>
      CREATE TRIGGER trg_audit_set_scores
        AFTER INSERT OR UPDATE OR DELETE ON set_scores
        FOR EACH ROW
        EXECUTE FUNCTION audit_log_changes();
    </sql>
    <rollback>
      DROP TRIGGER IF EXISTS trg_audit_set_scores ON set_scores;
    </rollback>
  </changeSet>

  <!-- game_scores -->
  <changeSet id="audit-trigger-game-scores" author="padelscore">
    <sql>
      CREATE TRIGGER trg_audit_game_scores
        AFTER INSERT OR UPDATE OR DELETE ON game_scores
        FOR EACH ROW
        EXECUTE FUNCTION audit_log_changes();
    </sql>
    <rollback>
      DROP TRIGGER IF EXISTS trg_audit_game_scores ON game_scores;
    </rollback>
  </changeSet>

  <!-- user_roles -->
  <changeSet id="audit-trigger-user-roles" author="padelscore">
    <sql>
      CREATE TRIGGER trg_audit_user_roles
        AFTER INSERT OR UPDATE OR DELETE ON user_roles
        FOR EACH ROW
        EXECUTE FUNCTION audit_log_changes();
    </sql>
    <rollback>
      DROP TRIGGER IF EXISTS trg_audit_user_roles ON user_roles;
    </rollback>
  </changeSet>

</databaseChangeLog>
