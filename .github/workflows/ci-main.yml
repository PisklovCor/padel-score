name: CI Pipeline (main)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_run:
    workflows: [ "CI Pipeline (develop)" ]
    types:
      - completed

jobs:
  build:
    name: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    outputs:
      is_release: ${{ steps.check-release.outputs.is_release }}

    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          ref: main

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–ª–∏–∑–Ω–æ–≥–æ –∫–æ–º–º–∏—Ç–∞
        id: check-release
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "Push —Å–æ–±—ã—Ç–∏–µ, –≤—ã–ø–æ–ª–Ω—è–µ–º —Å–±–æ—Ä–∫—É"
          else
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç –≤ main –≤–µ—Ç–∫–µ
            LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
            if echo "$LAST_COMMIT_MSG" | grep -q "Release version"; then
              echo "is_release=true" >> $GITHUB_OUTPUT
              echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω —Ä–µ–ª–∏–∑–Ω—ã–π –∫–æ–º–º–∏—Ç: $LAST_COMMIT_MSG"
            else
              echo "is_release=false" >> $GITHUB_OUTPUT
              echo "–≠—Ç–æ –Ω–µ —Ä–µ–ª–∏–∑–Ω—ã–π –∫–æ–º–º–∏—Ç (–ø–æ—Å–ª–µ–¥–Ω–∏–π: $LAST_COMMIT_MSG), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É"
            fi
          fi

      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ Maven –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2

      - name: –ö–æ–º–ø–∏–ª—è—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
        if: steps.check-release.outputs.is_release == 'true'
        run: mvn clean compile

      - name: –°–æ–∑–¥–∞–Ω–∏–µ JAR —Ñ–∞–π–ª–∞
        if: steps.check-release.outputs.is_release == 'true'
        run: mvn package -DskipTests

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å–±–æ—Ä–∫–∏
        if: steps.check-release.outputs.is_release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: jar-artifact
          path: target/padelscore-*.jar
          retention-days: 30
  docker-build:
    name: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
    runs-on: ubuntu-latest
    needs: build
    if: needs.build.outputs.is_release == 'true'

    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–∞
        run: |
          docker build -f Dockerfile -t padelscore:latest .
          docker tag padelscore:latest padelscore:${{ github.sha }}

      - name: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ Docker –æ–±—Ä–∞–∑–∞
        run: |
          docker save padelscore:latest | gzip > padelscore.tar.gz

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ Docker –æ–±—Ä–∞–∑–∞
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: padelscore.tar.gz
          retention-days: 30

  docker-push:
    name: Push –≤ Docker Hub
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout –∫–æ–¥
        uses: actions/checkout@v4

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–æ–≤
        run: |
          if [ -z "${{ secrets.DOCKER_USERNAME }}" ]; then
            echo "‚ùå DOCKER_USERNAME –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          if [ -z "${{ secrets.DOCKER_PASSWORD }}" ]; then
            echo "‚ùå DOCKER_PASSWORD –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
            exit 1
          fi
          echo "‚úÖ –°–µ–∫—Ä–µ—Ç—ã Docker –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã"

      - name: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ Docker –æ–±—Ä–∞–∑–∞
        uses: actions/download-artifact@v4
        with:
          name: docker-image
          path: .

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ Docker –æ–±—Ä–∞–∑–∞
        run: |
          gunzip -c padelscore.tar.gz | docker load

      - name: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ Docker Hub..."
          docker info | grep Username || echo "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"

      - name: Push –æ–±—Ä–∞–∑–∞ –≤ Docker Hub
        run: |
          DOCKER_USER="${{ secrets.DOCKER_USERNAME }}"
          echo "Docker username: $DOCKER_USER"

          docker images | grep padelscore || (echo "‚ùå –û–±—Ä–∞–∑ padelscore –Ω–µ –Ω–∞–π–¥–µ–Ω" && exit 1)

          docker tag padelscore:latest "${DOCKER_USER}/padelscore:latest"
          docker tag padelscore:latest "${DOCKER_USER}/padelscore:${{ github.sha }}"

          docker images | grep "${DOCKER_USER}/padelscore"

          echo "Pushing latest tag..."
          docker push "${DOCKER_USER}/padelscore:latest"

          echo "Pushing SHA tag..."
          docker push "${DOCKER_USER}/padelscore:${{ github.sha }}"

          echo "‚úÖ –û–±—Ä–∞–∑—ã —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –≤ Docker Hub"
          echo "üì¶ –†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: https://hub.docker.com/r/${DOCKER_USER}/padelscore"
